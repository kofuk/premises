<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
      <div class="container-fluid">
        <span class="navbar-brand">Control Panel</span>
        <div class="collapse navbar-collapse">
          <div class="navbar-nav me-auto"></div>
          <a href="/logout" class="btn btn-primary bg-gradient">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="alert d-none" role="alert" id="status">
        Running
      </div>

      <div class="my-5 card mx-auto" id="menu-build-server">
        <div class="card-body">
          <form id="start-form">
            Machine Type
            <div class="btn-group ms-3" role="group">
              <input type="radio" class="btn-check" name="machine-type" id="machine-1g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-1g">1G/2cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-2g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-2g">2GB/3cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-4g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-4g">4GB/4cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-8g" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="machine-8g">8GB/6cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-16g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-16g">16GB/8cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-32g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-32g">32GB/12cores</label>

              <input type="radio" class="btn-check" name="machine-type" id="machine-64g" autocomplete="off">
              <label class="btn btn-outline-primary" for="machine-64g">64GB/24cores</label>
            </div>
            <div class="d-md-block mt-3 text-end">
              <button class="btn btn-primary bg-gradient" id="start">Start</button>
            </div>
          </form>
        </div>
      </div>

      <div class="my-5 card mx-auto d-none" id="menu-server-control">
        <div class="card-body">
          <form id="control-form">
            <div class="d-md-block mt-3 text-end">
              <button class="btn btn-danger bg-gradient" id="stop">Stop</button>
            </div>
          </form>
        </div>
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

    <script>
     'use strict';

     const showStatus = (msg) => {
         const el = document.getElementById('status')
         el.classList.remove('d-none', 'alert-danger');
         el.classList.add('alert-success');
         el.innerText = msg;
     };

     const showError = (msg) => {
         const el = document.getElementById('status')
         el.classList.remove('d-none', 'alert-success');
         el.classList.add('alert-danger');
         el.innerText = msg;
     };

     const hideAlert = () => {
         const el = document.getElementById('status')
         el.classList.remove('alert-success', 'alert-danger');
         el.classList.add('d-none');
     };

     document.addEventListener('DOMContentLoaded', () => {
         const proto = location.protocol == 'https:' ? 'wss://' : 'ws://';
         const url = proto + location.host + '/control/api/status';
         const ws = new WebSocket(url);
         ws.addEventListener('message', e => {
             const event = JSON.parse(e.data);
             if (event.hasError) {
                 showError(event.status);
             } else {
                 showStatus(event.status);
             }
             if (event.shutdown) {
                 document.getElementById('menu-build-server').classList.remove('d-none');
                 document.getElementById('menu-server-control').classList.add('d-none');
             } else {
                 document.getElementById('menu-build-server').classList.add('d-none');
                 document.getElementById('menu-server-control').classList.remove('d-none');
             }
         });

         document.getElementById('start').addEventListener('click', (e) => {
             e.preventDefault();

             e.target.setAttribute('disabled', '');
             showStatus('Requesting...');

             fetch('/control/api/launch', {
                 method: 'POST'
             })
                 .then(response => response.json())
                 .then(data => {
                     if (!data.success) {
                         showError(data.message);
                         return;
                     }
                     e.target.removeAttribute('disabled')
                     document.getElementById('menu-build-server').classList.add('d-none');
                 })
                 .catch(err => {
                     showError('Failed to communicate with the server');
                     e.target.removeAttribute('disabled')
                 });
         });

         document.getElementById('stop').addEventListener('click', (e) => {
             e.preventDefault();

             e.target.setAttribute('disabled', '');
             showStatus('Requesting...');

             fetch('/control/api/stop', {
                 method: 'POST'
             })
                 .then(resp => resp.json())
                 .then(data => {
                     if (!data.success) {
                         showError(data.message);
                         return;
                     }
                     e.target.removeAttribute('disabled');
                     document.getElementById('menu-server-control').classList.add('d-none');
                 })
                 .catch(err => {
                     showError('Failed to communicate with the server');
                     e.target.removeAttribute('disabled');
                 });
         });
     });
    </script>
  </body>
</html>
